# https://github.com/edbizarro/gitlab-ci-pipeline-php
image: edbizarro/gitlab-ci-pipeline-php:7.2-alpine

stages:
  - build
  - test
  - metrics

variables:
  REPORT_DIR: "reports"
  PHPMETRICS: "v2.4.1"

cache:
  key: $CI_BUILD_REF_NAME
  paths:
    - vendor
    - web
    - composer.lock
    - security-checker.phar
    - phpmetrics.phar

.ensure_report:
  - &ensure_report
    mkdir -p ${REPORT_DIR} && chmod -R 777 ${REPORT_DIR}

.default_artifacts: &default_artifacts
  paths:
    - ${REPORT_DIR}/*.html
  name: "${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
  expire_in: 1 day
  when: always

.test_template: &test_template
  image: juampynr/drupal8ci:latest
  services:
    - mariadb:latest
  dependencies:
    - build
  before_script:
    - mkdir -p /var/www/html
    - ln -s $CI_PROJECT_DIR/web /var/www/html/web
    - apache2-foreground&
    - mkdir -p ${REPORT_DIR}/coverage-xml
    - mkdir -p ${REPORT_DIR}/coverage-html
    - *ensure_report
  script:
    - cd ${CI_PROJECT_DIR}/web
    - ${CI_PROJECT_DIR}/vendor/bin/drush status
    - ${CI_PROJECT_DIR}/vendor/bin/drush site-install --yes config_installer config_installer_sync_configure_form.sync_directory="../config/sync" --db-url=${SIMPLETEST_DB}
    # Skip core/tests/Drupal/Tests/ComposerIntegrationTest.php because web/ has no composer.json
    # Ignore PageCache group temporarily, @see https://www.drupal.org/node/2770673
    # Ignore Setup group temporarily, @see https://www.drupal.org/node/2962157
    - ${CI_PROJECT_DIR}/vendor/bin/phpunit -c core --testsuite unit --exclude-group Composer,DependencyInjection,PageCache,Setup --coverage-text --colors=never
    - ${CI_PROJECT_DIR}/vendor/bin/drush status > ../${REPORT_DIR}/drush.txt
    - ${CI_PROJECT_DIR}/vendor/bin/drupal site:status > ../${REPORT_DIR}/console.txt
  variables:
    MYSQL_ALLOW_EMPTY_PASSWORD: "1"
    MYSQL_DATABASE: "drupal"
    SIMPLETEST_DB: "mysql://root@mariadb/drupal"
    SIMPLETEST_BASE_URL: "http://localhost"
  # https://docs.gitlab.com/ee/ci/yaml/#coverage
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
  artifacts:
    <<: *default_artifacts
    paths:
      - ${REPORT_DIR}/*

.report_template: &report_template
  dependencies:
    - build
  before_script:
    - if [ ! -f ./${TOOL_PHAR} ];
      then
        curl -fsSL ${TOOL_URL} -o ${TOOL_PHAR};
      fi
    - chmod +x ${TOOL_PHAR}
    - *ensure_report
  artifacts:
    <<: *default_artifacts
    paths:
      - ${REPORT_DIR}/*.txt

build:
  stage: build
  script:
    - composer --verbose --no-check-all --no-check-publish validate
    - if [ ! -f "web/index.php" ];
      then
        composer install --prefer-dist --no-ansi --no-interaction --no-progress --quiet --profile;
      fi
    - if [ ! -f "web/themes/custom/bootstrap_sass/bootstrap_sass.theme" ];
      then
        composer --verbose install-boostrap-sass;
      fi

test:
  stage: test
  <<: *test_template

security report:
  stage: test
  <<: *report_template
  script:
    - ./${TOOL_PHAR} security:check
    - ./${TOOL_PHAR} security:check > ${REPORT_DIR}/security.txt
  variables:
    TOOL_PHAR: "security-checker.phar"
    TOOL_URL: "https://get.sensiolabs.org/security-checker.phar"

metrics:
  stage: metrics
  <<: *report_template
  script:
    - ./phpmetrics
        --report-html=${REPORT_DIR}
        --extensions=php,inc,module
        web
  variables:
    TOOL_PHAR: "phpmetrics.phar"
    TOOL_URL: "https://github.com/phpmetrics/PhpMetrics/releases/download/${PHPMETRICS}/phpmetrics.phar"
